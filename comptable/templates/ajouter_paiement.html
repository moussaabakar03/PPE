{% load static %}

<!doctype html>
<html class="no-js" lang="">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>AcadPro | Paiement √âl√®ve</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    {% include 'partial/head.html' %}

    <Link rel= "stylesheet" href="{% static 'comptable/ajoutPaiementEleve.css' %}">
        
</head>

<body>
    <div id="wrapper" class="wrapper bg-ash">

        <!-- Header Menu Area Start Here -->
        {% include 'partial/nav.html' %}
        <!-- Header Menu Area End Here -->

        <!-- Page Area Start Here -->
        <div class="dashboard-page-one">
            <!-- Sidebar Area Start Here -->
            {% include 'partial/asideComptable.html' %}

            <!-- Sidebar Area End Here -->
{% comment %} <> {% endcomment %}
            <div class="main-content full-page-form">
                <div class="container-fluid" style="margin-top: 50px;">
                    <div style="display: flex; flex-direction: column; align-items: center;  background-color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style= "display: flex; gap: 50px;"> 
                            <p><i class="fas fa-chalkboard"></i> {{ inscriptionEleve.salleClasse.niveau.classe }}- {{ inscriptionEleve.salleClasse.nom }}  </p>
                            <p>üìÜ{{ inscriptionEleve.anneeAcademique.debutAnnee|date:"Y" }} - {{ inscriptionEleve.anneeAcademique.fintAnnee|date:"Y" }} </p> 
                        </div> 
                        <p>Etudiant: <span style="margin-left: 10px; font-weight: bold;"> <i class="fas fa-user-graduate"></i> {{ inscriptionEleve.etudiant.nom }} {{ inscriptionEleve.etudiant.prenom }} </span></p>
                    </div>
                    <div class="conteneurPaiement" style = "display: flex; gap: 20px; flex-wrap: wrap; padding: 20px;">
                        <!-- Formulaire de paiement -->
                        <div class="payment-form" style =" overflow-x: auto; width: 50%!important;">
                            <div class="student-header">
                                <h2><i class="fas fa-money-bill-wave"></i> Enregistrement de Paiement</h2>
                                <h4 class="mt-3">
                                </h4>
                            </div>

                            <!-- Affichage des frais selon le type -->
                            <div class="fees-display" id="fees-display" style="display: none;">
                                <h5><i class="fas fa-calculator"></i> Frais applicables</h5>
                                <div id="fees-content">
                                    <!-- Les frais seront affich√©s ici -->
                                </div>
                            </div>

                            <!-- Section de calcul -->
                                <!-- Section de calcul -->
                            <div class="calculation-box">
                                <div class="row">
                                    <div class="col-md-12">
                                        <label>Total inclut des tous les frais(FCFA)</label>
                                        <input type="number" class="form-control" placeholder="" value="{{totalCout}}" readonly>
                                    </div>
                                    <div class="col-md-12">
                                        <label>Total d√©j√† pay√© (FCFA):</label>
                                        <input type="number" class="form-control" placeholder="" value="{{totalPaye}}" readonly>
                                    </div>
                                    <div class="col-md-12">
                                        <label>Reste Total √† pay√© (FCFA):</label>
                                        <input type="number" class="form-control" placeholder="" value="{{resteTotalPaye}}" readonly style ="color: red; font-weight: bold;">
                                    </div>
                                </div>
                            </div>
                            <hr>
                            
                            <form method="POST" id="payment-form">
                                {% csrf_token %}
                                <div class="form-section">
                                    <h5><i class="fas fa-info-circle"></i> Informations de paiement</h5>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label for="type_paiement" class="form-label">Type de paiement:</label>
                                            <select class="form-control" name="type_paiement" id="type_paiement" required>
                                                <option value="">-- Choix --</option>
                                                <option value="Frais de scolarit√©">Frais de scolarit√©</option>
                                                <option value="Frais d'inscription">Frais d'inscription</option>
                                                <option value="Frais d'√©tude du dossier">Frais d'√©tude du dossier</option>
                                                <option value="Frais Associ√©s">Frais Associ√©s</option>
                                                <option value="Autre">Autre</option>
                                            </select>
                                        </div>
                                        
                                    </div>
                                </div>
                                <hr>
                                <div class="calculation-box">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="total_a_payer">Total √† payer (FCFA):</label>
                                            <input type="number" id="montantTotal" name="montantTotal" class="form-control" readonly>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="montant_paye">Montant vers√© (FCFA):</label>
                                            <input type="number" id="montantVerse" class="form-control" name="montantVerse" placeholder="Ex: 25000" required min ="0">
                                        </div>
                                        <div class="col-md-4">
                                            <label>Reste √† payer (FCFA):</label>
                                            <input type="number" id="reste_a_payer" class="form-control" readonly style="background-color: #e9ecef; font-weight: bold;">
                                        </div>
                                        <div class="col-md-12">
                                            <div id="messageOnlyMontantVerser" class="text-danger mt-2"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <hr>
                                    <h5><i class="fas fa-credit-card"></i> Mode de paiement</h5>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label for="mode_paiement" class="form-label">Mode de paiement:</label>
                                            <select class="form-control" name="mode_paiement" id="mode_paiement" required>
                                                <option value="">-- Choix --</option>
                                                <option value="Esp√®ces">Esp√®ces</option>
                                                <option value="Ch√®que">Ch√®que</option>
                                                <option value="Mobile Money">Mobile Money</option>
                                                <option value="Virement">Virement</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <hr>
                                    <h5><i class="fas fa-calendar-alt"></i> P√©riode concern√©e</h5>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label for="mois" class="form-label">P√©riode concern√©:</label>
                                            <input type="text" name="periodeConcerne" class="form-control">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <hr>
                                    <h5><i class="fas fa-file-alt"></i> Informations compl√©mentaires</h5>
                                    <div class="row">
                                        <div class="col-12">
                                            <label for="description" class="form-label">Description:</label>
                                            <textarea class="form-control" name="description" id="description" rows="3" placeholder="D√©tails suppl√©mentaires..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <button type="submit" class="btn btn-submit btn-lg w-100 text-white">
                                            <i class="fas fa-save"></i> Enregistrer le paiement
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <a href="#" class="btn btn-danger btn-lg w-100">
                                            <i class="fas fa-times"></i> Annuler
                                        </a>
                                    </div>
                                </div>

                                <!-- Champ cach√© pour l'√©tudiant -->
                                <input type="hidden" name="etudiant" value="{{ etudiant.id }}">
                            </form>
                        </div>

                        <!-- Historique des paiements -->
                        <div class="payment-history" style = "width: 50%;">
                            <h2><i class="fas fa-history"></i> Historique des Paiements</h2>
                            
                            <table id="payments-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Montant(FCFA)</th>
                                        <th>periode_Concern√©</th>
                                        <th>M√©thode</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for paiement in paiements %}
                                        <tr>
                                            <td>{{ paiement.datePaiement|date:"d/m/Y" }}</td>
                                            <td>{{ paiement.typePaiement }}</td>
                                            <td class="paid">{{ paiement.montantVerse }}</td>
                                            {% comment %} <td class="remaining">{{ paiement.reste_a_payer }} FCFA</td> {% endcomment %}
                                            {% comment %} <td class="remaining">{{ paiement.periodeConcerne }}</td> {% endcomment %}
                                            <td>{{ paiement.periodeConcerne }}</td>
                                            <td>{{ paiement.modePaiment }}</td>
                                        </tr>
                                    {% endfor %}
                                     
                                    {% if not paiements %}
                                        <tr>
                                            <td colspan= "5" style = "text-align: center;" id="no-payments">Aucun paiement enregistr√© pour cet √©l√®ve.</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                            
                            <div class="summary" id="payment-summary">
                                <div class="summary-item">
                                    <span>Total d√ª:</span>
                                    <span id="total-due">{{ totalCout }} FCFA</span>
                                </div>
                                <div class="summary-item">
                                    <span>Total pay√©:</span>
                                    <span class="paid" id="total-paid">{{ totalPaye }} FCFA</span>
                                </div>
                                <div class="summary-item summary-total">
                                    <span>Reste √† payer:</span>
                                    <span class="remaining" style="color: red;" id="remaining-balance">{{ resteTotalPaye|default:0 }} FCFA</span>
                                </div>
                            </div>



                            <h2><i class="fas fa-history"></i> Historique des Paiements</h2>
                            
                            <table id="payments-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Montant(FCFA)</th>
                                        <th>periode_Concern√©</th>
                                        <th>M√©thode</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    
                                </tbody>
                            </table>
                           
                        </div>
                    </div>
                </div>
                <!-- Footer -->
                {% include 'partial/copyright.html' %}
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{% static 'secretaire/js/jquery-3.3.1.min.js' %}"></script>
    <script src="{% static 'secretaire/js/popper.min.js' %}"></script>
    <script src="{% static 'secretaire/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'secretaire/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'secretaire/js/main.js' %}"></script>
    <!-- Font Awesome pour les ic√¥nes -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <script>
        const frais = {
            'Frais de scolarit√©': {{ cout.coutScolarite|default:0 }},
            "Frais d'inscription": {{ cout.coutInscription|default:0 }},
            "Frais d'√©tude du dossier": {{ cout.fraisEtudeDossier|default:0 }},
            "Frais Associ√©s": {{ cout.fraisAssocie|default:0 }},
            "Autre": 0
        };

        const dejaPayeParType = {{ dejaPayeParType_json|safe }};

        const typePaiementSelect = document.getElementById('type_paiement');
        const totalAPayerInput = document.getElementById('montantTotal');
        const montantVerseInput = document.getElementById('montantVerse');
        const resteAPayerInput = document.getElementById('reste_a_payer');
        const paymentForm = document.getElementById('payment-form');

        function mettreAJourMontants() {
            const type = typePaiementSelect.value;
            const montantType = frais[type] || 0;
            const dejaPaye = dejaPayeParType[type] || 0;

            totalAPayerInput.value = montantType.toFixed(2);

            const montantVerse = parseFloat(montantVerseInput.value || 0);
            const reste = montantType - dejaPaye - montantVerse;

            resteAPayerInput.value = reste.toFixed(2);

            if (montantType <= dejaPaye) {
                montantVerseInput.value = "";
                montantVerseInput.disabled = true;
                resteAPayerInput.value = "0.00";
            } else {
                montantVerseInput.disabled = false;
            }
        }

        paymentForm.addEventListener('submit', function(e) {
            const type = typePaiementSelect.value;
            const montantType = frais[type] || 0;
            const dejaPaye = dejaPayeParType[type] || 0;
            const montantVerse = parseFloat(montantVerseInput.value || 0);

            if (dejaPaye + montantVerse > montantType) {
                e.preventDefault();
                alert("Le montant vers√© d√©passe ce qu'il reste √† payer.");
            }
        });

        typePaiementSelect.addEventListener('change', mettreAJourMontants);
        montantVerseInput.addEventListener('input', mettreAJourMontants);

        document.addEventListener('DOMContentLoaded', mettreAJourMontants);
    </script>

</body>
</html>