{% load static %}

<!doctype html>
<html class="no-js" lang="">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>AcadPro | Paiement Élève</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    {% include 'partial/head.html' %}
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container-fluid {
            flex: 1;
            padding: 20px;
            width: 100%;
        }
        
        .payment-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .payment-form {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 30px;
            flex: 1;
            min-width: 400px;
        }
        
        .payment-history {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 30px;
            flex: 1;
            min-width: 400px;
            max-height: 800px;
            overflow-y: auto;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
            border-bottom: 2px solid #ff9d01;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #34495e;
            margin: 20px 0 15px;
            font-size: 20px;
        }
        
        .calculation-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #ff9d01;
        }
        
        .fees-display {
            background-color: #e8f4f8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
        }
        
        .fee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .fee-label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .fee-amount {
            font-weight: bold;
            color: #28a745;
            font-size: 1.1em;
        }
        
        .calculation-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #ff9d01;
            outline: none;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .divider {
            border-top: 1px solid #eee;
            margin: 25px 0;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: auto;
            padding-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            text-align: center;
            transition: all 0.3s;
        }
        
        .btn-submit {
            background-color: #ff9d01;
            color: white;
            border: none;
        }
        
        .btn-submit:hover {
            background-color: #e68a00;
        }
        
        .btn-cancel {
            background-color: #f8f9fa;
            color: #2c3e50;
            border: 1px solid #ddd;
        }
        
        .btn-cancel:hover {
            background-color: #e9ecef;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .paid {
            color: green;
            font-weight: bold;
        }
        
        .remaining {
            color: orange;
            font-weight: bold;
        }
        
        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #ff9d01;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .summary-total {
            font-weight: bold;
            font-size: 1.1em;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .new-payment-row {
            background-color: #d4edda !important;
            border-left: 4px solid #28a745;
        }
        
        .animate-in {
            animation: slideIn 0.5s ease-in-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @media (max-width: 768px) {
            .calculation-grid, .info-grid {
                grid-template-columns: 1fr;
            }
            
            .payment-container {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <!-- Header Menu Area Start Here -->
    {% include 'partial/nav.html' %}
    <!-- Header Menu Area End Here -->

    <div class="dashboard-page-one">
        <!-- Sidebar Area Start Here -->
        {% include 'partial/asideComptable.html' %}
        <!-- Sidebar Area End Here -->

        <div class="main-content full-page-form">
            <div class="container-fluid">
                <div class="payment-container">
                    <!-- Formulaire de paiement -->
                    <div class="payment-form">
                        <div class="student-header">
                            <h2><i class="fas fa-money-bill-wave"></i> Enregistrement de Paiement</h2>
                            <h4 class="mt-3">
                                <i class="fas fa-user-graduate"></i> {{ eleve.etudiant.nom }} {{ eleve.etudiant.prenom }} | 
                                <i class="fas fa-chalkboard"></i> {{ eleve.salleClasse.niveau.classe }}- {{ eleve.salleClasse.nom }}  ---
                                {{ eleve.anneeAcademique.debutAnnee|date:"Y" }} - {{ eleve.anneeAcademique.fintAnnee|date:"Y" }} 
                            </h4>
                        </div>

                        <!-- Affichage des frais selon le type -->
                        <div class="fees-display" id="fees-display" style="display: none;">
                            <h5><i class="fas fa-calculator"></i> Frais applicables</h5>
                            <div id="fees-content">
                                <!-- Les frais seront affichés ici -->
                            </div>
                        </div>

                        <!-- Section de calcul -->
                        <div class="calculation-box">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="total_a_payer">Total à payer (FCFA):</label>
                                    <input type="number" id="total_a_payer" class="form-control" placeholder="Montant total" value="{{cout.coutScolarite}}" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label for="montant_paye">Montant payé (FCFA):</label>
                                    <input type="number" id="montant_paye" class="form-control" name="montant" placeholder="Ex: 25000" required>
                                </div>
                                <div class="col-md-4">
                                    <label>Reste à payer (FCFA):</label>
                                    <input type="number" id="reste_a_payer" class="form-control" readonly style="background-color: #e9ecef; font-weight: bold;">
                                </div>
                            </div>
                        </div>

                        <form method="POST" id="payment-form">
                            {% csrf_token %}
                            <div class="form-section">
                                <h5><i class="fas fa-info-circle"></i> Informations de paiement</h5>
                                <hr>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="type_paiement" class="form-label">Type de paiement:</label>
                                        <select class="form-control" name="type_paiement" id="type_paiement" required>
                                            <option value="">-- Choix --</option>
                                            <option value="Frais de scolarité">Frais de scolarité</option>
                                            <option value="Frais d'inscription">Frais d'inscription</option>
                                            <option value="Frais d'étude du dossier">Frais d'étude du dossier</option>
                                            <option value="Frais Associés">Frais Associés</option>
                                            <option value="Activité scolaire">Activité scolaire</option>
                                            <option value="Autre">Autre</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="date_paiement" class="form-label">Date de paiement:</label>
                                        <input type="date" class="form-control" name="date_paiement" id="date_paiement" required>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5><i class="fas fa-credit-card"></i> Mode de paiement</h5>
                                <hr>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="mode_paiement" class="form-label">Mode de paiement:</label>
                                        <select class="form-control" name="mode_paiement" id="mode_paiement" required>
                                            <option value="">-- Choix --</option>
                                            <option value="Espèces">Espèces</option>
                                            <option value="Chèque">Chèque</option>
                                            <option value="Mobile Money">Mobile Money</option>
                                            <option value="Virement">Virement</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="reference" class="form-label">Référence:</label>
                                        <input type="text" class="form-control" name="reference" id="reference" placeholder="N° chèque/transaction">
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5><i class="fas fa-calendar-alt"></i> Période concernée</h5>
                                <hr>
                                <div class="row">
                                    <div class="col-md-12">
                                        <label for="mois" class="form-label">Mois concerné:</label>
                                        <select class="form-control" name="mois" id="mois">
                                            <option value="">-- Tous les mois --</option>
                                            <option value="Janvier">Janvier</option>
                                            <option value="Février">Février</option>
                                            <option value="Mars">Mars</option>
                                            <option value="Avril">Avril</option>
                                            <option value="Mai">Mai</option>
                                            <option value="Juin">Juin</option>
                                            <option value="Juillet">Juillet</option>
                                            <option value="Août">Août</option>
                                            <option value="Septembre">Septembre</option>
                                            <option value="Octobre">Octobre</option>
                                            <option value="Novembre">Novembre</option>
                                            <option value="Décembre">Décembre</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5><i class="fas fa-file-alt"></i> Informations complémentaires</h5>
                                <hr>
                                <div class="row">
                                    <div class="col-12">
                                        <label for="description" class="form-label">Description:</label>
                                        <textarea class="form-control" name="description" id="description" rows="3" placeholder="Détails supplémentaires..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <button type="submit" class="btn btn-submit btn-lg w-100 text-white">
                                        <i class="fas fa-save"></i> Enregistrer le paiement
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <a href="#" class="btn btn-danger btn-lg w-100">
                                        <i class="fas fa-times"></i> Annuler
                                    </a>
                                </div>
                            </div>

                            <!-- Champ caché pour l'étudiant -->
                            <input type="hidden" name="etudiant" value="{{ etudiant.id }}">
                        </form>
                    </div>

                    <!-- Historique des paiements -->
                    <div class="payment-history">
                        <h2><i class="fas fa-history"></i> Historique des Paiements</h2>
                        
                        <table id="payments-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Montant</th>
                                    <th>Reste</th>
                                    <th>Méthode</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for paiement in paiements %}
                                <tr>
                                    <td>{{ paiement.date_paiement|date:"d/m/Y" }}</td>
                                    <td>{{ paiement.type_paiement }}</td>
                                    <td class="paid">{{ paiement.montant }} FCFA</td>
                                    <td class="remaining">{{ paiement.reste_a_payer }} FCFA</td>
                                    <td>{{ paiement.mode_paiement }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        
                        <div class="summary" id="payment-summary">
                            <div class="summary-item">
                                <span>Total payé:</span>
                                <span class="paid" id="total-paid">{{ total_paye|default:0 }} FCFA</span>
                            </div>
                            <div class="summary-item">
                                <span>Total dû:</span>
                                <span id="total-due">{{ total_a_payer|default:0 }} FCFA</span>
                            </div>
                            <div class="summary-item summary-total">
                                <span>Reste à payer:</span>
                                <span class="remaining" id="remaining-balance">{{ reste_a_payer|default:0 }} FCFA</span>
                            </div>
                        </div>
                        
                        {% if not paiements %}
                        <p id="no-payments">Aucun paiement enregistré pour cet élève.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            {% include 'partial/copyright.html' %}
        </div>
    </div>

    <!-- Scripts -->
    <script src="{% static 'secretaire/js/jquery-3.3.1.min.js' %}"></script>
    <script src="{% static 'secretaire/js/popper.min.js' %}"></script>
    <script src="{% static 'secretaire/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'secretaire/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'secretaire/js/main.js' %}"></script>
    <!-- Font Awesome pour les icônes -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    
    <script>
        $(document).ready(function() {
            const currentClass = '{{ classe.classe }}'; // Classe actuelle de l'étudiant
            let feesData = {};
            
            // Fonction pour charger les frais depuis all_cout.html
            function loadFeesData() {
                $.get('', function(data) {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data, 'text/html');
                    
                    // Parcourir le tableau des frais
                    const rows = doc.querySelectorAll('table tbody tr');
                    
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 6) {
                            const classe = cells[1].textContent.trim();
                            const fraisInscription = parseInt(cells[2].textContent.replace(/[^\d]/g, ''));
                            const fraisScolarite = parseInt(cells[3].textContent.replace(/[^\d]/g, ''));
                            const fraisEtudeDossier = parseInt(cells[4].textContent.replace(/[^\d]/g, ''));
                            const fraisAssocie = parseInt(cells[5].textContent.replace(/[^\d]/g, ''));
                            
                            // Stocker les frais par classe
                            if (!feesData[classe]) {
                                feesData[classe] = {};
                            }
                            
                            feesData[classe]['Frais d\'inscription'] = fraisInscription;
                            feesData[classe]['Frais de scolarité'] = fraisScolarite;
                            feesData[classe]['Frais d\'étude du dossier'] = fraisEtudeDossier;
                            feesData[classe]['Frais Associés'] = fraisAssocie;
                        }
                    });
                    
                    console.log('Frais chargés:', feesData);
                }).fail(function() {
                    // Si échec du chargement, utiliser des données par défaut
                    console.log('Impossible de charger les frais depuis all_cout.html');
                    feesData = {
                        '{{ classe.classe }}': {
                            'Frais de scolarité': 0,
                            'Frais d\'inscription': 0,
                            'Frais d\'étude du dossier': 0,
                            'Frais Associés': 0
                        }
                    };
                });
            }
            
            // Alternative: Utiliser les données Django directement (recommandé)
            // Si vous passez les données depuis la vue Django
            {% if couts %}
            feesData = {
                {% for cout in couts %}
                '{{ cout.classe.classe }}': {
                    'Frais d\'inscription': {{ cout.coutInscription }},
                    'Frais de scolarité': {{ cout.coutScolarite }},
                    'Frais d\'étude du dossier': {{ cout.fraisEtudeDossier }},
                    'Frais Associés': {{ cout.fraisAssocie }}
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            };
            {% else %}
            // Charger depuis all_cout.html si les données ne sont pas disponibles
            loadFeesData();
            {% endif %}
            
            // Fonction pour afficher les frais selon le type sélectionné
            function displayFees(paymentType) {
                const feesDisplay = $('#fees-display');
                const feesContent = $('#fees-content');
                
                if (paymentType && feesData[currentClass] && feesData[currentClass][paymentType]) {
                    const feeAmount = feesData[currentClass][paymentType];
                    
                    feesContent.html(`
                        <div class="fee-item">
                            <span class="fee-label">${paymentType} - ${currentClass}</span>
                            <span class="fee-amount">${feeAmount.toLocaleString()} FCFA</span>
                        </div>
                    `);
                    
                    // Mettre à jour le montant total automatiquement
                    $('#total_a_payer').val(feeAmount);
                    feesDisplay.show();
                    calculateBalance();
                } else if (paymentType === 'Autre') {
                    // Pour les autres types, permettre la saisie manuelle
                    feesContent.html(`
                        <div class="fee-item">
                            <span class="fee-label">Montant personnalisé</span>
                            <input type="number" id="custom_amount" class="form-control" placeholder="Saisir le montant" style="width: auto; display: inline-block;">
                        </div>
                    `);
                    $('#total_a_payer').val('').removeAttr('readonly');
                    feesDisplay.show();
                    
                    // Événement pour le montant personnalisé
                    $('#custom_amount').on('input', function() {
                        $('#total_a_payer').val($(this).val());
                        calculateBalance();
                    });
                } else {
                    feesDisplay.hide();
                    $('#total_a_payer').val('').attr('readonly', true);
                    calculateBalance();
                }
            }
            
            // Événement de changement du type de paiement
            $('#type_paiement').on('change', function() {
                displayFees($(this).val());
            });
            
            // Calcul automatique du reste à payer
            function calculateBalance() {
                const total = parseFloat($('#total_a_payer').val()) || 0;
                const paid = parseFloat($('#montant_paye').val()) || 0;
                const balance = total - paid;
                
                $('#reste_a_payer').val(balance.toFixed(0));
                
                // Changer la couleur selon le solde
                if(balance < 0) {
                    $('#reste_a_payer').css('color', 'red');
                } else if(balance > 0) {
                    $('#reste_a_payer').css('color', 'orange');
                } else {
                    $('#reste_a_payer').css('color', 'green');
                }
            }
            
            $('#total_a_payer, #montant_paye').on('input', calculateBalance);
            
            // Gestion de la soumission du formulaire
            $('#payment-form').on('submit', function(e) {
                e.preventDefault();
                
                // Récupérer les données du formulaire
                const formData = {
                    type_paiement: $('#type_paiement').val(),
                    date_paiement: $('#date_paiement').val(),
                    montant: $('#montant_paye').val(),
                    mode_paiement: $('#mode_paiement').val(),
                    reference: $('#reference').val(),
                    mois: $('#mois').val(),
                    description: $('#description').val(),
                    reste_a_payer: $('#reste_a_payer').val()
                };
                
                // Ajouter une nouvelle ligne au tableau
                addPaymentToTable(formData);
                
                // Mettre à jour le résumé
                updateSummary(formData);
                
                // Réinitialiser le formulaire
                resetForm();
                
                // Afficher un message de succès
                alert('Paiement enregistré avec succès !');
            });
            
            function addPaymentToTable(paymentData) {
                const tbody = $('#payments-table tbody');
                const today = new Date();
                const dateStr = today.toLocaleDateString('fr-FR');
                
                const newRow = `
                    <tr class="new-payment-row animate-in">
                        <td>${dateStr}</td>
                        <td>${paymentData.type_paiement}</td>
                        <td class="paid">${parseInt(paymentData.montant).toLocaleString()} FCFA</td>
                        <td class="remaining">${parseInt(paymentData.reste_a_payer).toLocaleString()} FCFA</td>
                        <td>${paymentData.mode_paiement}</td>
                    </tr>
                `;
                
                tbody.prepend(newRow);
                
                // Supprimer le message "Aucun paiement"
                $('#no-payments').hide();
            }
            
            function updateSummary(paymentData) {
                const currentTotalPaid = parseInt($('#total-paid').text().replace(/[^\d]/g, '')) || 0;
                const newTotalPaid = currentTotalPaid + parseInt(paymentData.montant);
                const totalDue = parseInt($('#total-due').text().replace(/[^\d]/g, '')) || 0;
                const newBalance = totalDue - newTotalPaid;
                
                $('#total-paid').text(newTotalPaid.toLocaleString() + ' FCFA');
                $('#remaining-balance').text(newBalance.toLocaleString() + ' FCFA');
            }
            
            function resetForm() {
                $('#payment-form')[0].reset();
                $('#fees-display').hide();
                $('#total_a_payer').val('');
                $('#reste_a_payer').val('');
            }
            
            // Définir la date d'aujourd'hui par défaut
            const today = new Date().toISOString().split('T')[0];
            $('#date_paiement').val(today);
            
            // Initial calculation
            calculateBalance();
        });
    </script>
</body>
</html>